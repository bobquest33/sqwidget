<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>twoosh</title>
    <script>
    widget.config({
      "name": "twoosh",
      "version": "0.0.1",
      "title": "twoosh: the socket dashboard",
      "desc": "Twitter socket connector widget",
      "url": "http://github.com/premasagar/sqwidget/plugins", // get the widget, via your taskbar
      "ui" : "hostpage",
       dependencies: ['messaging', 'swfobject', 'twstreamer']
    });
    </script>
    
    <style>
        .terminal {
            font-family: monospace;
        }
    </style>
    
    <script>
        $('body').data('w', widget);
        // use: var w = $('body').data('w');
    
        widget.ready(function(){
            var
                _ = sqwidget._ || window._ || function(){},
                plugins = widget.plugins,
                twstreamer = plugins.twstreamer,
                $ = jQuery,
                channel = 'government',
                user, pass;
                
            function getCredentials(){
                if (window.location.search.indexOf('?dev') === 0){
                    user = 'twidgetsqwidget';
                    pass = 'YADAyadaYADA';
                }
                else {
                    alert("We need your Twitter username & password, because the streaming API is limited to one connection per user. Your details are not stored.");
                    user = prompt("What's your Twitter username?");
                    pass = prompt("and your Twitter password?");
                }
            }
            
            function connect(q, callback){
                twstreamer
                    .init()
                    .credentials(user, pass)
                    .connect(
                        callback,
                        'track',
                        q,
                        'stream.twitter.com'
                    );
                _('connected to: ' + q);
            }
            function disconnect(){
                twstreamer.disconnect();
                _('disconnected');
            }
            
            function statusUrl(user, statusid){
                return 'http://twitter.com/' + user + '/status/' + statusid;
            }
            
            function tweetHtml(channel, tweet){
                return widget.renderWithTemplate(
                    "tweet", // microtemplating bug on single quotes
                    {channel:channel, tweet:tweet}
                );
            }
            
            // **
            
            getCredentials();
            
            /* // TEMP: bug? setTemplate doesn't work in callback
            widget.setTemplate(
                'waiting',
                null,
                {channel:channel}
            );
            */
            
            widget.setTemplate('waiting', null, {channel: channel});
            
            connect(channel, function(tweet){
                var html = tweetHtml(channel, tweet);
                _(tweet, html);
                $('#twoosh')
                    .html(html);
            });
        });
    </script>
    
    <script type="text/template" id="loading">
        <p>Loading...<p>
    </script>
    
    <script type="text/template" id="waiting">
        <p>Listening to '<span class="terminal">{{channel}}</span>'</p>
    </script>
    
    <script type="text/template" id="tweet">
        <h1 class=channel>{{channel}}</h1>
        
        <div class=tweet>
            <p>{{tweet.text}}</p>
            <p>
                <a href="{{statusUrl(tweet.user.screen_name, tweet.id)}}">{{tweet.user.screen_name}}</a>
            </p>
        </div>
    </script>
</head>

<body>
    lorem ipsum
</body>
</html>
