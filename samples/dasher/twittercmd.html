<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Twitter #cmd</title>
    <script>
    widget.config({
      "name": "twittercmd",
      "version": "1.0.0",
      "title": "Twitter #cmd",
      "desc": "Twitter socket connector widget, listening to #cmd",
      "url": "http://github.com/premasagar/sqwidget/plugins", // get the widget, via your taskbar
      "ui" : "hostpage",
       dependencies: ['messaging', 'swfobject', 'twstreamer']
    });
    </script>
    
    <script>
        widget.ready(function(){
            var
                _ = sqwidget._ || window._ || function(){},
                plugins = widget.plugins,
                twstreamer = plugins.twstreamer,
                $ = jQuery,
                channel = '#cmd',
                cmdRe = RegExp(channel + '\\s*(\\w+)\\s*(\\S*)');
            
            function parseTweet(tweet){
                function parseCmd(cmd){
                    _('log', cmd);
                    return cmd.match(cmdRe);
                }
            
                var
                    txt = $.trim(tweet.text),
                    cmd = parseCmd(txt),
                    sub, val;
                    
                _('cmd: ' + cmd, txt);
                
                if (!cmd){
                    return;
                }
                sub = cmd[1];
                val = cmd[2];
                
                $('h2.cmd').text(txt);
                
                // Route command                
                if (sub === 'q'){
                    // send to "search tweets"
                    plugins.messaging.send(
                        'set_search',
                        {text:val}
                    );
                }
            }
            
            function connect(q){
                twstreamer
                    .init()
                    .credentials('twidgetsqwidget', 'YADAyadaYADA')
                    .connect(
                        parseTweet,
                        'track',
                        q,
                        'stream.twitter.com'
                    );
                _('connected to: ' + q);
            }
            function disconnect(){
                twstreamer.disconnect();
                _('disconnected');
            }
                
            widget.setTemplate('default');
            
            $('form.cmd')
                .submit(function(){
                    return false;
                });
            
            $('button.connect')
                .click(function(){
                    var q = $('.cmd input[name=q]').val();
                    disconnect();
                    connect(q);
                });
                
            $('button.disconnect')
                .click(function(){
                    disconnect();
                });
                
            connect('#cmd');
        });
    </script>
    <script type="text/template" id="loading">
        <p>Loading...<p>
    </script>
</head>

<body>
    <p>Command line</p>
    <form class=cmd>
        <label>key</label>
        <input name=q value="#cmd">
        <button class=connect>Connect</button>
        <button class=disconnect>Disconnect</button>
    </form>
</body>
</html>
