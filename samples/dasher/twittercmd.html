<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Twitter #cmd</title>
    <script>
    widget.config({
      "name": "twittercmd",
      "version": "1.0.0",
      "title": "Twitter #cmd",
      "desc": "Twitter socket connector widget, listening to #cmd",
      "url": "http://github.com/premasagar/sqwidget/plugins", // get the widget, via your taskbar
      "ui" : "hostpage",
       dependencies: ['messaging', 'swfobject', 'twstreamer']
    });
    </script>
    
    <script>
        widget.ready(function(){
            var
                _ = sqwidget._ || window._ || function(){},
                plugins = widget.plugins,
                twstreamer = plugins.twstreamer,
                $ = jQuery;
            
            function parseTweet(tweet){
                var
                    txt = tweet.text,
                    key = '#cmd',
                    cmd = $.trim(
                        txt.slice(txt.indexOf(key) + key.length)
                    ),
                    val;
                
                // Route command
                if (cmd.indexOf('search ') === 0){
                    val = cmd.slice('search '.length);
                    
                    // send to "search tweets"
                    plugins.messaging.send(
                        'set_search',
                        {text:val}
                    );
                }
            }
            
            function connect(q){
                twstreamer
                    .init()
                    .credentials('twidgetsqwidget', 'YADAyadaYADA')
                    .connect(
                        parseTweet,
                        'track',
                        q,
                        'stream.twitter.com'
                    );
                _('connected to: ' + q);
            }
            function disconnect(){
                twstreamer.disconnect();
                _('disconnected');
            }
                
            widget.setTemplate('default');
            
            $('form.cmd')
                .submit(function(){
                    return false;
                });
            
            $('button.connect')
                .click(function(){
                    var q = $('.cmd input[name=q]').val();
                    disconnect();
                    connect(q);
                });
                
            $('button.disconnect')
                .click(function(){
                    disconnect();
                });
                
            connect('#cmd');
        });
    </script>
    <script type="text/template" id="loading">
        <p>Loading...<p>
    </script>
</head>

<body>
    <p>Command line</p>
    <form class=cmd>
        <label>key</label>
        <input name=q value="#cmd">
        <button class=connect>Connect</button>
        <button class=disconnect>Disconnect</button>
    </form>
</body>
</html>
